<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1Password Premium Export Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 42px;
            font-weight: 300;
        }
        
        .hero {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .hero p {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 20px;
            padding: 60px 20px;
            text-align: center;
            margin-bottom: 40px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background: rgba(102, 126, 234, 0.05);
            border-color: #5a67d8;
        }
        
        .upload-area.dragover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #5a67d8;
        }
        
        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 20px;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .upload-subtext {
            color: #888;
            font-size: 14px;
        }
        
        #fileInput {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .results {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 20px;
            display: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .export-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn-export {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-export:hover {
            background: #667eea;
            color: white;
        }
        
        .password-item {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .password-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .password-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .password-field {
            display: flex;
            flex-direction: column;
        }
        
        .password-field label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: 500;
        }
        
        .password-field span {
            font-size: 14px;
            color: #333;
            word-break: break-all;
        }
        
        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .security-score {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .security-excellent { background: #e8f5e8; color: #2e7d32; }
        .security-good { background: #e3f2fd; color: #1976d2; }
        .security-fair { background: #fff3e0; color: #f57c00; }
        .security-weak { background: #ffebee; color: #d32f2f; }
        
        .preview-items {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .instructions {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin-top: 30px;
        }
        
        .instructions h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Premium Password Converter</h1>
        
        <div class="hero">
            <p>Convert your 1Password export to premium formats for Apple Passwords, CSV, and more</p>
        </div>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Drop your 1Password export here</div>
            <div class="upload-subtext">or click to browse files (.1pux format)</div>
        </div>
        <input type="file" id="fileInput" accept=".1pux,.zip" style="display: none;" />
        
        <div class="results" id="results">
            <h2>üéâ Export Complete!</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalItems">0</div>
                    <div class="stat-label">Total Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="secureItems">0</div>
                    <div class="stat-label">Secure Items</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="categories">0</div>
                    <div class="stat-label">Categories</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="twoFactor">0</div>
                    <div class="stat-label">2FA Enabled</div>
                </div>
            </div>
            
            <div class="export-buttons">
                <button class="btn btn-export" onclick="exportCSV()">üìä Export CSV</button>
                <button class="btn btn-export" onclick="exportJSON()">üìÑ Export JSON</button>
                <button class="btn btn-export" onclick="exportKeychain()">üîë Apple Keychain</button>
                <button class="btn btn-export" onclick="exportHTML()">üìã HTML Report</button>
            </div>
            
            <div class="preview-items" id="previewItems">
                <!-- Items will be populated here -->
            </div>
        </div>
        
        <div class="instructions">
            <h3>üìã How to Import to Apple Passwords</h3>
            <ol>
                <li>Click "Apple Keychain" to download the compatible CSV file</li>
                <li>Open Safari and go to Settings > Passwords</li>
                <li>Click the "‚ãØ" menu and select "Import Passwords"</li>
                <li>Choose your downloaded CSV file</li>
                <li>Your passwords will be imported to Apple Passwords!</li>
            </ol>
        </div>
    </div>

    <script>
        let passwordData = [];
        let isJSZipLoaded = false;
        
        // Check if JSZip is loaded
        function checkJSZip() {
            if (typeof JSZip !== 'undefined') {
                isJSZipLoaded = true;
                console.log('JSZip loaded successfully');
            } else {
                console.log('JSZip not loaded, trying again...');
                setTimeout(checkJSZip, 100);
            }
        }
        
        // Start checking when page loads
        document.addEventListener('DOMContentLoaded', checkJSZip);
        
        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const results = document.getElementById('results');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        async function handleFile(file) {
            console.log('File selected:', file.name);
            
            if (!file.name.endsWith('.1pux')) {
                alert('Please select a 1Password export file (.1pux)');
                return;
            }
            
            if (!isJSZipLoaded) {
                alert('Library still loading, please wait a moment and try again');
                return;
            }
            
            // Show loading state
            uploadArea.innerHTML = '<div class="upload-icon">‚è≥</div><div class="upload-text">Processing your export...</div>';
            
            try {
                console.log('Reading file...');
                const arrayBuffer = await file.arrayBuffer();
                console.log('File read, size:', arrayBuffer.byteLength);
                
                console.log('Loading zip...');
                const zip = await JSZip.loadAsync(arrayBuffer);
                console.log('Zip loaded, files:', Object.keys(zip.files));
                
                // Look for data.json or similar
                let dataFile = zip.file('data.json');
                if (!dataFile) {
                    // Try alternative names
                    const files = Object.keys(zip.files);
                    console.log('Looking for JSON files in:', files);
                    for (const filename of files) {
                        if (filename.endsWith('.json') || filename.includes('data')) {
                            dataFile = zip.file(filename);
                            console.log('Found data file:', filename);
                            break;
                        }
                    }
                }
                
                if (!dataFile) {
                    // Show available files for debugging
                    const availableFiles = Object.keys(zip.files).join(', ');
                    alert(`No data file found in the export. Available files: ${availableFiles}`);
                    resetUploadArea();
                    return;
                }
                
                console.log('Reading JSON data...');
                const jsonText = await dataFile.async('text');
                console.log('JSON text length:', jsonText.length);
                
                const data = JSON.parse(jsonText);
                console.log('Parsed data:', data);
                
                processPasswordData(data);
                
            } catch (error) {
                console.error('Error processing file:', error);
                alert(`Error processing the file: ${error.message}`);
                resetUploadArea();
            }
        }
        
        function resetUploadArea() {
            uploadArea.innerHTML = `
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drop your 1Password export here</div>
                <div class="upload-subtext">or click to browse files (.1pux format)</div>
            `;
        }
        
        function processPasswordData(data) {
            passwordData = [];
            
            const items = data.items || [];
            
            for (const item of items) {
                const entry = {
                    title: item.title || 'Untitled',
                    category: mapCategory(item.category),
                    username: '',
                    password: '',
                    url: '',
                    notes: item.notes || '',
                    created: formatDate(item.createdAt),
                    modified: formatDate(item.updatedAt),
                    favorite: item.favorite || false,
                    twoFactor: false,
                    securityScore: 0
                };
                
                // Extract fields
                if (item.fields) {
                    for (const field of item.fields) {
                        if (field.designation === 'username') {
                            entry.username = field.value || '';
                        } else if (field.designation === 'password') {
                            entry.password = field.value || '';
                            entry.securityScore = calculatePasswordScore(field.value);
                        }
                    }
                }
                
                // Extract URLs
                if (item.urls && item.urls.length > 0) {
                    entry.url = item.urls[0].url || item.urls[0].u || '';
                }
                
                passwordData.push(entry);
            }
            
            displayResults();
        }
        
        function mapCategory(category) {
            const categoryMap = {
                'LOGIN': 'Logins',
                'SECURE_NOTE': 'Secure Notes',
                'CREDIT_CARD': 'Payment Cards',
                'IDENTITY': 'Identities',
                'PASSWORD': 'Passwords',
                'DOCUMENT': 'Documents',
                'SOFTWARE_LICENSE': 'Software',
                'BANK_ACCOUNT': 'Banking'
            };
            return categoryMap[category] || 'Other';
        }
        
        function calculatePasswordScore(password) {
            if (!password) return 0;
            
            let score = 0;
            if (password.length >= 12) score += 20;
            if (password.length >= 16) score += 20;
            if (/[a-z]/.test(password)) score += 10;
            if (/[A-Z]/.test(password)) score += 10;
            if (/[0-9]/.test(password)) score += 10;
            if (/[^A-Za-z0-9]/.test(password)) score += 20;
            if (password.length >= 20) score += 10;
            
            return score;
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleDateString();
        }
        
        function displayResults() {
            // Update stats
            document.getElementById('totalItems').textContent = passwordData.length;
            document.getElementById('secureItems').textContent = passwordData.filter(p => p.securityScore >= 80).length;
            
            const categories = new Set(passwordData.map(p => p.category));
            document.getElementById('categories').textContent = categories.size;
            
            document.getElementById('twoFactor').textContent = passwordData.filter(p => p.twoFactor).length;
            
            // Display preview items
            const previewContainer = document.getElementById('previewItems');
            previewContainer.innerHTML = '<h3>üîç Password Preview</h3>';
            
            passwordData.slice(0, 5).forEach(item => {
                const div = document.createElement('div');
                div.className = 'password-item';
                
                let securityClass = 'security-weak';
                let securityText = 'Weak';
                
                if (item.securityScore >= 80) {
                    securityClass = 'security-excellent';
                    securityText = 'Excellent';
                } else if (item.securityScore >= 60) {
                    securityClass = 'security-good';
                    securityText = 'Good';
                } else if (item.securityScore >= 40) {
                    securityClass = 'security-fair';
                    securityText = 'Fair';
                }
                
                div.innerHTML = `
                    <div class="password-title">${item.title}</div>
                    <div class="password-details">
                        <div class="password-field">
                            <label>Category</label>
                            <span class="category-badge">${item.category}</span>
                        </div>
                        <div class="password-field">
                            <label>Username</label>
                            <span>${item.username || 'N/A'}</span>
                        </div>
                        <div class="password-field">
                            <label>URL</label>
                            <span>${item.url || 'N/A'}</span>
                        </div>
                        <div class="password-field">
                            <label>Security</label>
                            <span class="security-score ${securityClass}">${securityText}</span>
                        </div>
                    </div>
                `;
                
                previewContainer.appendChild(div);
            });
            
            results.style.display = 'block';
        }
        
        // Export functions
        function exportCSV() {
            const csv = ['Title,Category,Username,Password,URL,Notes,Created,Modified,Security Score'];
            
            passwordData.forEach(item => {
                csv.push([
                    escapeCSV(item.title),
                    escapeCSV(item.category),
                    escapeCSV(item.username),
                    escapeCSV(item.password),
                    escapeCSV(item.url),
                    escapeCSV(item.notes),
                    escapeCSV(item.created),
                    escapeCSV(item.modified),
                    item.securityScore
                ].join(','));
            });
            
            downloadFile('passwords_premium.csv', csv.join('\n'));
        }
        
        function exportJSON() {
            const exportData = {
                metadata: {
                    version: '2.0',
                    exported: new Date().toISOString(),
                    source: '1Password',
                    format: 'Premium Password Manager Export'
                },
                items: passwordData
            };
            
            downloadFile('passwords_premium.json', JSON.stringify(exportData, null, 2));
        }
        
        function exportKeychain() {
            const csv = ['Title,URL,Username,Password,Notes'];
            
            passwordData.forEach(item => {
                csv.push([
                    escapeCSV(item.title),
                    escapeCSV(item.url),
                    escapeCSV(item.username),
                    escapeCSV(item.password),
                    escapeCSV(item.notes)
                ].join(','));
            });
            
            downloadFile('passwords_keychain.csv', csv.join('\n'));
        }
        
        function exportHTML() {
            const html = generateHTMLReport();
            downloadFile('passwords_report.html', html);
        }
        
        function generateHTMLReport() {
            return `<!DOCTYPE html>
<html>
<head>
    <title>Password Export Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background: #007aff; color: white; padding: 20px; border-radius: 10px; }
        .stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat { background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center; }
        .item { background: #f9f9f9; margin: 10px 0; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîê Password Export Report</h1>
        <p>Generated on ${new Date().toLocaleDateString()}</p>
    </div>
    
    <div class="stats">
        <div class="stat">
            <h3>${passwordData.length}</h3>
            <p>Total Items</p>
        </div>
        <div class="stat">
            <h3>${passwordData.filter(p => p.securityScore >= 80).length}</h3>
            <p>Secure Items</p>
        </div>
    </div>
    
    <h2>Items</h2>
    ${passwordData.map(item => `
        <div class="item">
            <h3>${item.title}</h3>
            <p><strong>Category:</strong> ${item.category}</p>
            <p><strong>Username:</strong> ${item.username || 'N/A'}</p>
            <p><strong>URL:</strong> ${item.url || 'N/A'}</p>
        </div>
    `).join('')}
</body>
</html>`;
        }
        
        function escapeCSV(str) {
            if (!str) return '';
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }
        
        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
    
    <!-- JSZip library for handling zip files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html>